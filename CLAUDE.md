  # CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Sales AI Agent Dashboard** - An internal B2B agency tool for managing and tracking sales leads. Single-tenant application with simple password authentication, integrating with n8n automation workflows and Supabase backend.

**Tech Stack:**
- Frontend: React 18 + TypeScript + Vite + Tailwind CSS + shadcn-ui
- Backend: Supabase Edge Functions (Deno runtime)
- Database: Supabase PostgreSQL
- Integration: n8n webhooks for data aggregation
- Project ID: `lthcgfjrsacctythakll`

## Development Commands

```bash
# Install dependencies
npm install

# Start dev server (runs on http://localhost:8080)
npm run dev

# Build for production
npm run build

# Build for development (with source maps)
npm run build:dev

# Lint code
npm run lint

# Preview production build
npm run preview
```

## Architecture & Data Flow

### Three-Layer Architecture

1. **Frontend (React SPA)**
   - Entry: `src/main.tsx` → `src/App.tsx`
   - Routes: `/` (dashboard), `/login`
   - State: React hooks + localStorage for auth token
   - API layer: `src/lib/api.ts` (abstracts all backend calls)

2. **Backend (Supabase Edge Functions)**
   - 4 serverless functions in `supabase/functions/`:
     - `auth` - Password-based login
     - `dashboard` - Fetch cached dashboard data
     - `leads` - Fetch individual lead details
     - `refresh` - Trigger n8n webhook and update cache

3. **Data Layer (Supabase PostgreSQL)**
   - `LeadTracker` - Meta/Facebook ads leads (numeric IDs)
   - `Website_Lead_Tracker` - Website form submissions (UUID IDs)
   - `dashboard_cache` - Pre-aggregated JSON snapshot (single row, id=1)

### Data Flow Pattern

```
n8n Workflow (triggered by webhook/schedule):
  ├─ Query LeadTracker (Meta leads)
  ├─ Query Website_Lead_Tracker (Website leads)
  ├─ Normalize both to common format
  ├─ Merge and aggregate (summary stats + full lead list)
  └─ Update dashboard_cache with unified payload

User clicks "Refresh" → Triggers n8n webhook → Cache updated

Frontend:
  ├─ Fetches dashboard_cache → Displays unified KPIs + all leads
  └─ Click lead → `/leads` Edge Function determines table by ID type:
      ├─ UUID → Query Website_Lead_Tracker
      └─ Numeric → Query LeadTracker
```

**Critical:**
- The dashboard does NOT query lead tables directly. It reads pre-aggregated data from `dashboard_cache.payload` (JSONB column) for performance.
- The `/leads` Edge Function auto-detects lead source by ID format (UUID vs numeric) and queries the appropriate table.
- Both lead sources are unified in the dashboard with a `lead_source` field ('Meta' or 'Website').

## Database Schema Details

### LeadTracker Table (Meta/Facebook Ads Leads)
- **ID type:** Numeric (auto-increment)
- **Column naming quirk:** Uses mixed case with spaces: `"Company name"`, `"Phone_number"`, `"Ad_ID"`, `"Ad Name"`, `"where?"`, `"what matters?"`, `"experience with technology"`
- **conversation_history:** Text field with AI-generated conversation thread
- **Scoring fields:** `persona_fit`, `activation_fit`, `intent_score`, `average_score` (all numeric)
- **Meta-specific:** `meta_lead_id`, `Ad_ID`, `Ad Name` for Facebook ads tracking
- **assigned_to:** Text field for lead assignment (nullable)
- Indexes on: `master_status`, `status`, `next_followup_timestamp`

### Website_Lead_Tracker Table (Website Form Submissions)
- **ID type:** UUID (generated by Postgres)
- **Name fields:** `first_name`, `last_name` (separate, unlike LeadTracker's single `name`)
- **conversation_history:** Text field with AI conversation (mapped from `conversation` in some queries)
- **Initial message:** `message` field captures the user's original inquiry
- **No scoring:** Does not have persona_fit, activation_fit, intent_score fields (all null in unified view)
- **No Meta data:** No ad tracking, meta_lead_id, company fields
- **Followup:** Uses `Next_Followup_Time` (capitalized, unlike LeadTracker's snake_case)
- **assigned_to:** Text field for lead assignment (nullable)

### dashboard_cache Table
- Single-row table (id always = 1)
- `payload` column is JSONB containing full dashboard snapshot
- Expected structure:
  ```typescript
  {
    updated_at: string (ISO UTC timestamp),
    summary: {
      // Basic counts
      total_leads: number,
      by_status: Record<string, number>,
      by_master_status: Record<string, number>,
      by_country: Record<string, number>,
      by_lead_source: Record<string, number>,

      // Follow-up metrics
      followups_due_now: number,        // Overdue + due today
      followups_due_this_week: number,  // Due in next 7 days

      // New leads tracking
      new_leads_last_24h: number,
      new_leads_last_7_days: number,
      new_leads_last_30_days: number,

      // Engagement metrics
      total_leads_with_replies: number,
      response_rate: number,           // Percentage (0-100)

      // Lead quality metrics
      hot_leads_count: number,
      qualified_leads_count: number,
      dead_leads_count: number,
      conversion_rate: number,          // Percentage to Hot/Qualified
      dead_lead_rate: number,          // Percentage

      // Score metrics (Meta leads only)
      avg_lead_score: number,          // Out of 10
      avg_persona_fit: number,         // Out of 10
      avg_activation_fit: number,      // Out of 10
      avg_intent_score: number,        // Out of 10
      total_meta_leads: number
    },
    leads: Array<LeadRow>  // Denormalized lead data from BOTH tables
  }
  ```

**Note:** All analytics calculated in n8n aggregation node. Response rate checks for "Customer Reply" in conversation_history.

## Authentication Flow

**Non-standard implementation:** Due to Supabase Edge Functions having JWT verification enabled, the app uses a workaround:

1. User enters password (`wizjow-robzy6-havrYz`)
2. Frontend validates password locally in `src/lib/api.ts`
3. On success, stores **Supabase anon key** as auth token
4. All subsequent API calls use this anon key, which passes JWT verification

**Important:** This bypasses the `/auth` Edge Function. Real password validation happens client-side.

## Timezone Handling

All timestamps are displayed in **Asia/Dubai (UTC+4 / GST)** timezone. The conversion logic is in `src/lib/timezone.ts`:
- **Library:** Uses `date-fns-tz` for proper timezone conversion
- **Input:** n8n sends UTC timestamps in format "YYYY-MM-DD hh:mm A", conversation parser converts to UTC ISO strings
- **Storage:** All timestamps stored as UTC ISO 8601 strings
- **Output:** Dubai time formatted as "h:mm a GST" (e.g., "10:18 AM")
- **Key Function:** `formatInTimeZone(new Date(utcIsoString), 'Asia/Dubai', formatStr)`
- **Critical:** Conversation parser in `src/lib/conversation.ts` explicitly parses n8n timestamps as UTC by appending ' UTC' before creating Date object
- **Important:** n8n must send UTC timestamps - frontend handles all timezone conversion to Dubai time

## Mock Data Mode

`src/lib/api.ts` has a `USE_MOCK_DATA` flag at the top:
- `true` = Uses hardcoded mock data (for testing without backend)
- `false` = Uses real Supabase API

Currently set to `false` (production mode).

## Edge Functions Deployment

Edge Functions are deployed via Supabase Dashboard (JWT verification prevents CLI deployment without special permissions).

**Required Secrets (set in Supabase Dashboard → Edge Functions → Secrets):**
- `DASHBOARD_PASSWORD` - Password for login
- `N8N_REFRESH_WEBHOOK_URL` - n8n webhook endpoint
- `N8N_REFRESH_SECRET` - API key for n8n authentication

**Auto-provided by Supabase (don't set these):**
- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`
- `SUPABASE_ANON_KEY`

## n8n Integration

### Workflow Structure

The n8n workflow processes leads from both sources:

1. **Branch A (Meta Leads):**
   - Query LeadTracker via Supabase node
   - Process/normalize with code node (map column names)
   - Output: Array of normalized Meta leads

2. **Branch B (Website Leads):**
   - Query Website_Lead_Tracker via Supabase node
   - Process/normalize with code node (combine first_name + last_name, etc.)
   - Output: Array of normalized Website leads

3. **Merge Node:** Combines both arrays (append mode)

4. **Aggregation Code Node:**
   - Receives all leads (Meta + Website)
   - Calculates summary stats (followups_due_now, followups_due_this_week, etc.)
   - Builds unified payload
   - **IMPORTANT:** Must include `conversation_history` in the output

5. **Update dashboard_cache:** Writes to Supabase

### Key Points

- n8n returns an **array** `[{...}]`, the refresh Edge Function extracts `array[0]`
- Both branches must output normalized leads BEFORE aggregation
- Aggregation happens ONCE after merge (not in individual branches)
- `lead_source` field must be added ('Meta' or 'Website') for UI badges

## Component Structure

- `src/pages/Dashboard.tsx` - Main orchestration (state, filters, data fetching, sorting, pagination)
- `src/components/dashboard/` - Dashboard-specific components:
  - `DashboardHeader` - Enhanced header with gradient logo, Dubai time display (GST), gradient refresh button, "Live" badge
  - `KPICards` - Beautiful analytics dashboard with:
    - **Hero Metrics Row:** 4 gradient cards (Total Pipeline, Hot Opportunities, Conversion Rate, Response Rate)
    - **Activity Section:** 4 cards with time-based metrics (Due Now, 24h, 7d, 30d)
    - **Quality & Distribution:** 2 large cards with Lead Quality Scores (progress bars) and Pipeline Distribution (horizontal bars)
  - `LeadFilters` - Search and dropdown filters (Name/Email, Stage, Status, Country, Assigned to, Created date range)
  - `LeadTable` - Sortable desktop table view with 11 columns: Name, Email, Company, Country, Status, Stage, Assigned (dropdown), Created, Score, Last Contact, Follow-up
  - `MobileLeadCard` - Mobile card view with lead source badges and assignment dropdown
  - `LeadDetail` - Side panel/modal for lead details (works for both lead sources), displays Assigned To field
  - `AssignmentDropdown` - Reusable dropdown for assigning leads to team members, used in both LeadTable and MobileLeadCard

## Known Issues & Workarounds

1. **JWT Verification:** Edge Functions have `verify_jwt: true` which can't be disabled via MCP tool. Current workaround uses anon key.

2. **Column name mapping:** Both lead tables use non-standard column names:
   - LeadTracker: Mixed case with spaces (`"Company name"`, `"Ad_ID"`)
   - Website_Lead_Tracker: Capitalized fields (`Next_Followup_Time`)
   - Edge Functions and n8n code nodes manually normalize these to camelCase

3. **Lead ID type detection:** The `/leads` Edge Function uses UUID regex to determine if a lead is from Website_Lead_Tracker (UUID) or LeadTracker (numeric), then queries the appropriate table.

## Environment Configuration

Frontend uses **Vite environment variables** (must be prefixed with `VITE_`):
```
VITE_SUPABASE_URL=https://lthcgfjrsacctythakll.supabase.co
VITE_SUPABASE_PUBLISHABLE_KEY=<anon key>
VITE_SUPABASE_PROJECT_ID=lthcgfjrsacctythakll
```

**Never commit** `.env` with actual keys. The anon key is safe to expose (read-only access), but service role key must stay server-side only.

## Supabase MCP Integration

Project has Supabase MCP server configured in `.mcp.json` for database inspection and Edge Function management:
```json
{
  "mcpServers": {
    "supabase": {
      "url": "https://mcp.supabase.com/mcp?project_ref=lthcgfjrsacctythakll",
      ...
    }
  }
}
```

Use MCP tools to query tables, check Edge Function status, and execute SQL.

## Type Safety

All dashboard types are defined in `src/types/dashboard.ts`:
- `DashboardPayload` - Full dashboard snapshot
- `LeadRow` - Lead summary for table (supports both UUID and numeric IDs)
- `LeadDetail` - Extended lead with conversation history
- `DashboardSummary` - KPI statistics

TypeScript is strictly enforced. Pay attention to:
- **ID field:** `id: number | string` (numeric for Meta, UUID string for Website)
- **Nullable fields:** Most fields can be null (Website leads lack scores, company, ad data)
- **Optional fields:** `lead_source?: string`, `initial_message?: string | null`, `assigned_to?: string | null`
- Timestamp string formats (ISO 8601)
- Score fields as `number | null`

## Production Deployment (Hostinger VPS)

The dashboard is deployed on a Hostinger VPS alongside n8n, using Docker and Traefik reverse proxy.

### Live URL
- **Dashboard:** https://dashboard.queenpowerinteractive.cloud
- **n8n:** https://n8n.queenpowerinteractive.cloud

### Server Architecture

```
Hostinger VPS (queenpowerinteractive.cloud)
├── Traefik (reverse proxy, ports 80/443, auto SSL)
├── sales-dashboard (Nginx container serving static build)
├── n8n (workflow automation)
├── n8n-worker (background job processor)
├── PostgreSQL (n8n database)
└── Redis (n8n queue)
```

### File Locations on VPS

```
/root/
├── docker-compose.yml    # Main Docker stack config
├── .env                  # n8n environment variables
└── redis-data/           # Redis persistence

/var/www/sales-dashboard/
├── .env                  # Vite environment variables (Supabase keys)
├── dist/                 # Production build (served by Nginx)
├── Dockerfile            # Nginx-based container
├── nginx.conf            # SPA routing config
├── src/                  # Source code
└── package.json          # Dependencies
```

### Docker Compose Configuration

The dashboard service in `/root/docker-compose.yml`:

```yaml
dashboard:
  image: sales-dashboard
  restart: always
  labels:
    - traefik.enable=true
    - traefik.http.routers.dashboard.rule=Host(`dashboard.${DOMAIN_NAME}`)
    - traefik.http.routers.dashboard.tls=true
    - traefik.http.routers.dashboard.entrypoints=web,websecure
    - traefik.http.routers.dashboard.tls.certresolver=mytlschallenge
```

### Dockerfile

Located at `/var/www/sales-dashboard/Dockerfile`:

```dockerfile
FROM nginx:alpine
COPY dist/ /usr/share/nginx/html/
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
```

### Nginx Configuration

Located at `/var/www/sales-dashboard/nginx.conf`:

```nginx
server {
    listen 80;
    root /usr/share/nginx/html;
    index index.html;
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

### Deploying Updates

**From your local machine (after making code changes):**

1. Push changes to GitHub:
   ```bash
   git add .
   git commit -m "Your changes"
   git push origin main
   ```

2. SSH into VPS:
   ```bash
   ssh root@141.136.36.201
   ```

3. Pull and rebuild:
   ```bash
   cd /var/www/sales-dashboard
   git pull origin main
   npm install        # Only if dependencies changed
   npm run build
   docker build -t sales-dashboard .
   cd ~
   docker compose up -d
   ```

**Quick deploy script (run on VPS):**

```bash
cd /var/www/sales-dashboard && git pull && npm run build && docker build -t sales-dashboard . && cd ~ && docker compose up -d
```

### Useful VPS Commands

```bash
# View running containers
docker ps

# View dashboard logs
docker logs root-dashboard-1

# Restart all services
cd ~ && docker compose restart

# Restart only dashboard
docker compose restart dashboard

# Rebuild and redeploy dashboard only
cd /var/www/sales-dashboard && npm run build && docker build -t sales-dashboard . && cd ~ && docker compose up -d dashboard

# Check Traefik logs (for SSL/routing issues)
docker logs root-traefik-1

# SSH access
ssh root@141.136.36.201
```

### Environment Variables on VPS

**Dashboard `.env`** (`/var/www/sales-dashboard/.env`):
```
VITE_SUPABASE_PROJECT_ID="lthcgfjrsacctythakll"
VITE_SUPABASE_PUBLISHABLE_KEY="<anon-key>"
VITE_SUPABASE_URL="https://lthcgfjrsacctythakll.supabase.co"
```

**n8n `.env`** (`/root/.env`):
```
DOMAIN_NAME=queenpowerinteractive.cloud
SUBDOMAIN=n8n
GENERIC_TIMEZONE=Europe/Berlin
SSL_EMAIL=admin@queenpowerinteractive.cloud
```

### Troubleshooting

| Issue | Solution |
|-------|----------|
| Dashboard not loading | Check `docker ps` - is container running? Check `docker logs root-dashboard-1` |
| SSL certificate error | Wait 2-3 min for Let's Encrypt. Check `docker logs root-traefik-1` |
| 502 Bad Gateway | Dashboard container crashed. Run `docker compose restart dashboard` |
| Changes not appearing | Forgot to rebuild? Run full deploy script above |
| n8n webhook not working | Check n8n is running: `docker logs root-n8n-1` |

### GitHub Repository

- **URL:** https://github.com/powerinteractivesales/sales-ai-hub
- **Branch:** main
- **Visibility:** Private (use PAT for cloning)

## Recent Major Changes

### Lead Assignment Dropdown (Dec 27, 2024)
- **New Component:** `src/components/dashboard/AssignmentDropdown.tsx`
- **Inline Dropdown:** Replaced static "Assigned to" text with interactive dropdown in LeadTable and MobileLeadCard
- **Team Members (hardcoded):**
  - Zeeshan Qazafi
  - Shemeer Mohammed
  - Naji Saeed
  - Tharindu Hettiarchchi
- **Webhook Integration:** Calls `{lead.assign_webhook_url}&assignee={URL_ENCODED_NAME}` on selection
- **UX Features:**
  - Loading spinner during webhook call
  - Toast notifications for success/error with "Please refresh to see changes" message
  - Check mark indicator for current assignee
  - Click propagation stopped to prevent row selection
- **Styling:** Ghost button variant, `text-sm` font size

### Lead Creation Date Tracking & Filtering (Dec 27, 2024)
- **New Fields in LeadRow:** `created_at?: string | null`, `assign_webhook_url?: string`
- **n8n Integration:** Both normalization code nodes (Meta/Website) now pass `created_at` and aggregation builds `assign_webhook_url` per lead
- **Date Range Filter:**
  - Compact date picker in filters row (inline with other filters)
  - Side-by-side "From" and "To" calendars in popover
  - Filter leads by creation date range
- **"Created" Column:** Added sortable column to LeadTable (between Assigned and Score)
- **Mobile:** Shows creation date in MobileLeadCard
- **Date Format:** `MMM d, h:mma` in Dubai timezone (e.g., "Dec 27, 4:41am")

### Table UI Improvements (Dec 27, 2024)
- **Full Width Layout:** Removed `container` max-width constraint, table now uses `w-full px-6`
- **Text Size:** Increased from `text-xs` (12px) to `text-sm` (14px) for better readability
- **Cell Padding:** Increased from `px-2` to `px-3`
- **Responsive:** Table uses native `<table>` element with `overflow-x-auto` container
- **Stage Badge:** Increased size to `text-sm px-2 py-0.5`
- **Lead Source Badge:** Compact `text-xs` badges showing "Web" or "Meta"

### Lead Assignment Feature (Dec 6, 2024)
- **Database Schema:** Added `assigned_to` column to both LeadTracker and Website_Lead_Tracker tables
- **n8n Integration:** Updated normalization code nodes to pass through `assigned_to` field
- **Frontend Display:**
  - Added sortable "Assigned to" column in LeadTable (positioned after Stage column)
  - Shows "—" for unassigned leads
  - Mobile card displays assignment with "Assigned: {name}" label
  - Lead detail panel includes "Assigned To" field
- **Filtering:** Added "Assigned to" dropdown filter to filter leads by assignee
- **Edge Functions:** Updated `/leads` function to fetch and return `assigned_to` for both lead sources
- **Type Safety:** Added `assigned_to?: string | null` to LeadRow interface

### Enhanced Analytics Dashboard (Dec 5, 2024)
- **Comprehensive Analytics:** Added 15+ new KPI metrics including response rate, conversion rate, lead quality scores, and time-based tracking (7d, 30d)
- **Beautiful UI Redesign:** Complete visual overhaul with gradient backgrounds, progress bars, modern shadows, and premium SaaS aesthetic
- **Fixed Timezone Display:** Properly converts UTC to Dubai time (GST) using `date-fns-tz` library
- **n8n Enhanced Aggregation:** Updated code node to calculate engagement metrics, quality scores, and conversion analytics
- **Refresh Edge Function Fix:** Now properly extracts data from n8n's array response format
- **Sorting & Pagination:** Added column sorting (Name, Score, Last Contact, Next Follow-up, Assigned to) and pagination (10/25/50/100 per page)

### Unified Lead Dashboard (Dec 2024)
- **Multi-source support:** Dashboard now displays leads from both LeadTracker (Meta ads) and Website_Lead_Tracker (website forms)
- **Smart ID detection:** `/leads` Edge Function auto-detects table by ID type (UUID vs numeric)
- **Visual indicators:** Blue badges for Website leads, purple for Meta leads
- **Follow-up tracking:** Changed from "due today" to "due this week" for better forward visibility
- **Stage badge sizing:** Increased text size and padding for better readability
- **n8n workflow:** Now has dual-branch structure to query and merge both lead sources before aggregation

### Conversation History Structured Format (Dec 24, 2024)
- **Problem:** Conversation history was stored as plain text/HTML strings with poor visual separation between AI messages and customer replies, making it difficult to read conversation flow
- **Solution:** Implemented structured JSON format with beautiful message bubbles while maintaining full backward compatibility

#### Data Format

**Database Storage:**
- Both `LeadTracker` and `Website_Lead_Tracker` tables store `conversation_history` as TEXT field
- `dashboard_cache` receives transformed JSON format for optimal frontend rendering
- Old string format still supported for legacy data

**New JSON Structure:**
```typescript
interface ConversationMessage {
  role: 'ai' | 'customer' | 'human_initial' | 'followup';
  content: string;
  timestamp: string; // ISO 8601 UTC
  messageType?: 'initial_outreach' | 'reply' | 'customer_reply' | 'form_response' | 'followup_1' | 'followup_2' | 'followup_3';
  source?: 'meta' | 'website';
}

// Stored as: JSON.stringify(ConversationMessage[])
```

#### Delimiter Patterns

**Old Delimiters (Legacy - No Timestamp):**
- `AI Initial Outreach:`
- `AI Reply:`
- `PEOPLE WHO FILLED OUT FORM AGAIN - `
- `Customer Reply:`
- `Human inital message - ` (note: typo in original)
- `Initial Outreach:`
- `Lead message:`
- `follow up 1 :` (with colon)
- `follow up 2 :` (with colon)
- `follow up 3 :` (with colon)

**New Delimiters (With Timestamp in UTC):**
- `Initial Outreach by AI - {{ $now.format('YYYY-MM-DD hh:mm A') }}`
- `Reply by Power Interactive - {{ $now.format('YYYY-MM-DD hh:mm A') }}`
- `Customer Reply - {{ $now.format('YYYY-MM-DD hh:mm A') }}`
- `Initial Form Response - {{ $now.format('YYYY-MM-DD hh:mm A') }}`
- `follow up 1 - {{ $now.format('YYYY-MM-DD hh:mm A') }}` (with dash)
- `follow up 2 - {{ $now.format('YYYY-MM-DD hh:mm A') }}` (with dash)
- `follow up 3 - {{ $now.format('YYYY-MM-DD hh:mm A') }}` (with dash)

**CRITICAL:** All timestamps from n8n MUST be in UTC timezone. n8n's `$now` variable uses UTC by default.

**Format Pattern:**
```
{{ existing_conversation_history }}

[Delimiter] - {{ $now.format('YYYY-MM-DD hh:mm A') }}  <!-- UTC timestamp -->

{{ new_message_content }}
```

#### Implementation Details

**Frontend Components:**
1. **`src/lib/conversation.ts`** - Parsing utilities:
   - `parseConversation()` - Handles both JSON and string formats
   - `isStructuredConversation()` - Detects format type
   - `groupMessagesByDate()` - Groups messages by date for UI
   - `getMessageLabel()` - Returns display labels for message types

2. **`src/components/dashboard/LeadDetail.tsx`** - UI components:
   - `MessageBubble` - Beautiful message bubbles with role-based styling:
     - **AI messages:** White background, left-aligned
     - **Customer messages:** Dark gradient background (slate-900), right-aligned
     - **Follow-ups:** Blue gradient background, left-aligned
   - `ConversationThread` - Groups messages by date with separators
   - Replaced `dangerouslySetInnerHTML` with structured rendering
   - **Backward compatible:** Old HTML strings still render via fallback

3. **`src/types/dashboard.ts`** - Added `ConversationMessage` interface

**n8n Aggregation Node:**
- **Location:** Main aggregation code node (before posting to webhook)
- **Function:** `parseConversationToStructured(conversationHistory, leadSource)`
  - Parses old string format into JSON array
  - Extracts timestamps from delimiter lines (e.g., "Customer Reply - 2025-12-24 03:45 PM")
  - Cleans customer email signatures/noise (removes `[cid:image...]`, email footers)
  - Supports ALL old and new delimiters for full backward compatibility
  - Returns JSON.stringify(ConversationMessage[])
- **Integration:** One line change in `slimLeads.push()` to call parser on `conversation_history`

**Email Signature Cleaning:**
Automatically removes from customer messages:
- Image references: `[cid:image...]`
- Email footers: Lines starting with `E:`, `M:`, `T:`
- Excessive whitespace

#### Backward Compatibility

**Dual Format Support:**
- Frontend detects format (JSON array vs string) automatically
- Old conversations: Display as plain HTML or parse delimiters
- New conversations: Beautiful structured message bubbles
- No data migration required
- Zero breaking changes

**Migration Strategy:**
- Week 1: Deploy frontend (supports both formats)
- Week 2: Update n8n delimiters with timestamps
- Week 3+: Gradual migration as leads refresh naturally
- Old data continues working indefinitely

#### Visual Design

**Message Bubble Styling:**
- Matches KPI card design system (gradients, shadows, rounded corners)
- Role-based color coding for instant recognition
- Timestamps in Dubai timezone (GST) using `date-fns-tz`
- Date separators with horizontal lines
- Responsive design (adapts to mobile/desktop)

**Color Scheme:**
- AI: `bg-white dark:bg-slate-950` with `border-slate-200`
- Customer: `bg-gradient-to-br from-slate-900 to-slate-800` with white text
- Follow-ups: `bg-gradient-to-br from-blue-50 to-blue-100` with blue accents
- Timestamps: Muted colors (`text-slate-400`)

#### Critical Files

- **`src/lib/conversation.ts`** - Core parsing logic (NEW)
- **`src/types/dashboard.ts`** - ConversationMessage interface
- **`src/components/dashboard/LeadDetail.tsx`** - Message bubble UI
- **n8n Aggregation Code Node** - Data transformation (manual update)

#### Testing Checklist

- ✅ Legacy HTML format (existing leads)
- ✅ New JSON format (after n8n update)
- ✅ Empty conversation_history
- ✅ Malformed data (fallback gracefully)
- ✅ Very long conversations (100+ messages)
- ✅ Dark mode rendering
- ✅ Mobile responsiveness
- ✅ Timezone display (Dubai/GST)
- ✅ Old delimiters with colons (legacy follow-ups)
- ✅ New delimiters with dashes and timestamps
