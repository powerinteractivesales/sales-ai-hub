  # CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Sales AI Agent Dashboard** - An internal B2B agency tool for managing and tracking sales leads. Single-tenant application with simple password authentication, integrating with n8n automation workflows and Supabase backend.

**Tech Stack:**
- Frontend: React 18 + TypeScript + Vite + Tailwind CSS + shadcn-ui
- Backend: Supabase Edge Functions (Deno runtime)
- Database: Supabase PostgreSQL
- Integration: n8n webhooks for data aggregation
- Project ID: `lthcgfjrsacctythakll`

## Development Commands

```bash
# Install dependencies
npm install

# Start dev server (runs on http://localhost:8080)
npm run dev

# Build for production
npm run build

# Build for development (with source maps)
npm run build:dev

# Lint code
npm run lint

# Preview production build
npm run preview
```

## Architecture & Data Flow

### Three-Layer Architecture

1. **Frontend (React SPA)**
   - Entry: `src/main.tsx` → `src/App.tsx`
   - Routes: `/` (dashboard), `/login`
   - State: React hooks + localStorage for auth token
   - API layer: `src/lib/api.ts` (abstracts all backend calls)

2. **Backend (Supabase Edge Functions)**
   - 4 serverless functions in `supabase/functions/`:
     - `auth` - Password-based login
     - `dashboard` - Fetch cached dashboard data
     - `leads` - Fetch individual lead details
     - `refresh` - Trigger n8n webhook and update cache

3. **Data Layer (Supabase PostgreSQL)**
   - `LeadTracker` - Meta/Facebook ads leads (numeric IDs)
   - `Website_Lead_Tracker` - Website form submissions (UUID IDs)
   - `dashboard_cache` - Pre-aggregated JSON snapshot (single row, id=1)

### Data Flow Pattern

```
n8n Workflow (triggered by webhook/schedule):
  ├─ Query LeadTracker (Meta leads)
  ├─ Query Website_Lead_Tracker (Website leads)
  ├─ Normalize both to common format
  ├─ Merge and aggregate (summary stats + full lead list)
  └─ Update dashboard_cache with unified payload

User clicks "Refresh" → Triggers n8n webhook → Cache updated

Frontend:
  ├─ Fetches dashboard_cache → Displays unified KPIs + all leads
  └─ Click lead → `/leads` Edge Function determines table by ID type:
      ├─ UUID → Query Website_Lead_Tracker
      └─ Numeric → Query LeadTracker
```

**Critical:**
- The dashboard does NOT query lead tables directly. It reads pre-aggregated data from `dashboard_cache.payload` (JSONB column) for performance.
- The `/leads` Edge Function auto-detects lead source by ID format (UUID vs numeric) and queries the appropriate table.
- Both lead sources are unified in the dashboard with a `lead_source` field ('Meta' or 'Website').

## Database Schema Details

### LeadTracker Table (Meta/Facebook Ads Leads)
- **ID type:** Numeric (auto-increment)
- **Column naming quirk:** Uses mixed case with spaces: `"Company name"`, `"Phone_number"`, `"Ad_ID"`, `"Ad Name"`, `"where?"`, `"what matters?"`, `"experience with technology"`
- **conversation_history:** Text field with AI-generated conversation thread
- **Scoring fields:** `persona_fit`, `activation_fit`, `intent_score`, `average_score` (all numeric)
- **Meta-specific:** `meta_lead_id`, `Ad_ID`, `Ad Name` for Facebook ads tracking
- **assigned_to:** Text field for lead assignment (nullable)
- Indexes on: `master_status`, `status`, `next_followup_timestamp`

### Website_Lead_Tracker Table (Website Form Submissions)
- **ID type:** UUID (generated by Postgres)
- **Name fields:** `first_name`, `last_name` (separate, unlike LeadTracker's single `name`)
- **conversation_history:** Text field with AI conversation (mapped from `conversation` in some queries)
- **Initial message:** `message` field captures the user's original inquiry
- **No scoring:** Does not have persona_fit, activation_fit, intent_score fields (all null in unified view)
- **No Meta data:** No ad tracking, meta_lead_id, company fields
- **Followup:** Uses `Next_Followup_Time` (capitalized, unlike LeadTracker's snake_case)
- **assigned_to:** Text field for lead assignment (nullable)

### dashboard_cache Table
- Single-row table (id always = 1)
- `payload` column is JSONB containing full dashboard snapshot
- Expected structure:
  ```typescript
  {
    updated_at: string (ISO UTC timestamp),
    summary: {
      // Basic counts
      total_leads: number,
      by_status: Record<string, number>,
      by_master_status: Record<string, number>,
      by_country: Record<string, number>,
      by_lead_source: Record<string, number>,

      // Follow-up metrics
      followups_due_now: number,        // Overdue + due today
      followups_due_this_week: number,  // Due in next 7 days

      // New leads tracking
      new_leads_last_24h: number,
      new_leads_last_7_days: number,
      new_leads_last_30_days: number,

      // Engagement metrics
      total_leads_with_replies: number,
      response_rate: number,           // Percentage (0-100)

      // Lead quality metrics
      hot_leads_count: number,
      qualified_leads_count: number,
      dead_leads_count: number,
      conversion_rate: number,          // Percentage to Hot/Qualified
      dead_lead_rate: number,          // Percentage

      // Score metrics (Meta leads only)
      avg_lead_score: number,          // Out of 10
      avg_persona_fit: number,         // Out of 10
      avg_activation_fit: number,      // Out of 10
      avg_intent_score: number,        // Out of 10
      total_meta_leads: number
    },
    leads: Array<LeadRow>  // Denormalized lead data from BOTH tables
  }
  ```

**Note:** All analytics calculated in n8n aggregation node. Response rate checks for "Customer Reply" in conversation_history.

## Authentication Flow

**Non-standard implementation:** Due to Supabase Edge Functions having JWT verification enabled, the app uses a workaround:

1. User enters password (`wizjow-robzy6-havrYz`)
2. Frontend validates password locally in `src/lib/api.ts`
3. On success, stores **Supabase anon key** as auth token
4. All subsequent API calls use this anon key, which passes JWT verification

**Important:** This bypasses the `/auth` Edge Function. Real password validation happens client-side.

## Timezone Handling

All timestamps are displayed in **Asia/Dubai (UTC+4 / GST)** timezone. The conversion logic is in `src/lib/timezone.ts`:
- **Library:** Uses `date-fns-tz` for proper timezone conversion
- **Input:** UTC timestamps from n8n and database
- **Output:** Dubai time formatted as "8:17:45 PM GST"
- **Key Function:** `formatInTimeZone(new Date(isoString), 'Asia/Dubai', formatStr)`
- **Important:** n8n sends UTC timestamps, frontend converts to Dubai time for display

## Mock Data Mode

`src/lib/api.ts` has a `USE_MOCK_DATA` flag at the top:
- `true` = Uses hardcoded mock data (for testing without backend)
- `false` = Uses real Supabase API

Currently set to `false` (production mode).

## Edge Functions Deployment

Edge Functions are deployed via Supabase Dashboard (JWT verification prevents CLI deployment without special permissions).

**Required Secrets (set in Supabase Dashboard → Edge Functions → Secrets):**
- `DASHBOARD_PASSWORD` - Password for login
- `N8N_REFRESH_WEBHOOK_URL` - n8n webhook endpoint
- `N8N_REFRESH_SECRET` - API key for n8n authentication

**Auto-provided by Supabase (don't set these):**
- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`
- `SUPABASE_ANON_KEY`

## n8n Integration

### Workflow Structure

The n8n workflow processes leads from both sources:

1. **Branch A (Meta Leads):**
   - Query LeadTracker via Supabase node
   - Process/normalize with code node (map column names)
   - Output: Array of normalized Meta leads

2. **Branch B (Website Leads):**
   - Query Website_Lead_Tracker via Supabase node
   - Process/normalize with code node (combine first_name + last_name, etc.)
   - Output: Array of normalized Website leads

3. **Merge Node:** Combines both arrays (append mode)

4. **Aggregation Code Node:**
   - Receives all leads (Meta + Website)
   - Calculates summary stats (followups_due_now, followups_due_this_week, etc.)
   - Builds unified payload
   - **IMPORTANT:** Must include `conversation_history` in the output

5. **Update dashboard_cache:** Writes to Supabase

### Key Points

- n8n returns an **array** `[{...}]`, the refresh Edge Function extracts `array[0]`
- Both branches must output normalized leads BEFORE aggregation
- Aggregation happens ONCE after merge (not in individual branches)
- `lead_source` field must be added ('Meta' or 'Website') for UI badges

## Component Structure

- `src/pages/Dashboard.tsx` - Main orchestration (state, filters, data fetching, sorting, pagination)
- `src/components/dashboard/` - Dashboard-specific components:
  - `DashboardHeader` - Enhanced header with gradient logo, Dubai time display (GST), gradient refresh button, "Live" badge
  - `KPICards` - Beautiful analytics dashboard with:
    - **Hero Metrics Row:** 4 gradient cards (Total Pipeline, Hot Opportunities, Conversion Rate, Response Rate)
    - **Activity Section:** 4 cards with time-based metrics (Due Now, 24h, 7d, 30d)
    - **Quality & Distribution:** 2 large cards with Lead Quality Scores (progress bars) and Pipeline Distribution (horizontal bars)
  - `LeadFilters` - Search and dropdown filters (Name/Email, Stage, Status, Country, Assigned to)
  - `LeadTable` - Sortable desktop table view with lead source badges (blue=Website, purple=Meta), includes Assigned to column
  - `MobileLeadCard` - Mobile card view with lead source badges, shows assignment info
  - `LeadDetail` - Side panel/modal for lead details (works for both lead sources), displays Assigned To field

## Known Issues & Workarounds

1. **JWT Verification:** Edge Functions have `verify_jwt: true` which can't be disabled via MCP tool. Current workaround uses anon key.

2. **Column name mapping:** Both lead tables use non-standard column names:
   - LeadTracker: Mixed case with spaces (`"Company name"`, `"Ad_ID"`)
   - Website_Lead_Tracker: Capitalized fields (`Next_Followup_Time`)
   - Edge Functions and n8n code nodes manually normalize these to camelCase

3. **Lead ID type detection:** The `/leads` Edge Function uses UUID regex to determine if a lead is from Website_Lead_Tracker (UUID) or LeadTracker (numeric), then queries the appropriate table.

## Environment Configuration

Frontend uses **Vite environment variables** (must be prefixed with `VITE_`):
```
VITE_SUPABASE_URL=https://lthcgfjrsacctythakll.supabase.co
VITE_SUPABASE_PUBLISHABLE_KEY=<anon key>
VITE_SUPABASE_PROJECT_ID=lthcgfjrsacctythakll
```

**Never commit** `.env` with actual keys. The anon key is safe to expose (read-only access), but service role key must stay server-side only.

## Supabase MCP Integration

Project has Supabase MCP server configured in `.mcp.json` for database inspection and Edge Function management:
```json
{
  "mcpServers": {
    "supabase": {
      "url": "https://mcp.supabase.com/mcp?project_ref=lthcgfjrsacctythakll",
      ...
    }
  }
}
```

Use MCP tools to query tables, check Edge Function status, and execute SQL.

## Type Safety

All dashboard types are defined in `src/types/dashboard.ts`:
- `DashboardPayload` - Full dashboard snapshot
- `LeadRow` - Lead summary for table (supports both UUID and numeric IDs)
- `LeadDetail` - Extended lead with conversation history
- `DashboardSummary` - KPI statistics

TypeScript is strictly enforced. Pay attention to:
- **ID field:** `id: number | string` (numeric for Meta, UUID string for Website)
- **Nullable fields:** Most fields can be null (Website leads lack scores, company, ad data)
- **Optional fields:** `lead_source?: string`, `initial_message?: string | null`, `assigned_to?: string | null`
- Timestamp string formats (ISO 8601)
- Score fields as `number | null`

## Recent Major Changes

### Lead Assignment Feature (Dec 6, 2024)
- **Database Schema:** Added `assigned_to` column to both LeadTracker and Website_Lead_Tracker tables
- **n8n Integration:** Updated normalization code nodes to pass through `assigned_to` field
- **Frontend Display:**
  - Added sortable "Assigned to" column in LeadTable (positioned after Stage column)
  - Shows "—" for unassigned leads
  - Mobile card displays assignment with "Assigned: {name}" label
  - Lead detail panel includes "Assigned To" field
- **Filtering:** Added "Assigned to" dropdown filter to filter leads by assignee
- **Edge Functions:** Updated `/leads` function to fetch and return `assigned_to` for both lead sources
- **Type Safety:** Added `assigned_to?: string | null` to LeadRow interface

### Enhanced Analytics Dashboard (Dec 5, 2024)
- **Comprehensive Analytics:** Added 15+ new KPI metrics including response rate, conversion rate, lead quality scores, and time-based tracking (7d, 30d)
- **Beautiful UI Redesign:** Complete visual overhaul with gradient backgrounds, progress bars, modern shadows, and premium SaaS aesthetic
- **Fixed Timezone Display:** Properly converts UTC to Dubai time (GST) using `date-fns-tz` library
- **n8n Enhanced Aggregation:** Updated code node to calculate engagement metrics, quality scores, and conversion analytics
- **Refresh Edge Function Fix:** Now properly extracts data from n8n's array response format
- **Sorting & Pagination:** Added column sorting (Name, Score, Last Contact, Next Follow-up, Assigned to) and pagination (10/25/50/100 per page)

### Unified Lead Dashboard (Dec 2024)
- **Multi-source support:** Dashboard now displays leads from both LeadTracker (Meta ads) and Website_Lead_Tracker (website forms)
- **Smart ID detection:** `/leads` Edge Function auto-detects table by ID type (UUID vs numeric)
- **Visual indicators:** Blue badges for Website leads, purple for Meta leads
- **Follow-up tracking:** Changed from "due today" to "due this week" for better forward visibility
- **Stage badge sizing:** Increased text size and padding for better readability
- **n8n workflow:** Now has dual-branch structure to query and merge both lead sources before aggregation
